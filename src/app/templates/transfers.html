{% extends "base.html" %}
{% block content %}
  <section class="page-head">
    <div>
      <h1 class="page-title">Transfers</h1>
      <p class="page-subtitle">Наблюдаемые входящие транзакции со статусами матчинга и объяснениями причин.</p>
    </div>
  </section>

  <section class="kpi-grid kpi-grid-compact">
    {% for status, meta in transfer_status_meta.items() %}
      <article class="kpi-card">
        <div class="kpi-label">{{ meta.label }}</div>
        <div class="kpi-value">{{ status_counts.get(status, 0) }}</div>
      </article>
    {% endfor %}
  </section>

  <section class="panel">
    <div class="panel-head">
      <div>
        <h2 class="panel-title">Observed Transfers</h2>
        <p class="panel-subtitle">До 400 последних tx. Ошибочные причины и конфликтные кейсы отображаются отдельно.</p>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Network</th>
            <th>Tx hash</th>
            <th>Amount</th>
            <th>Confirmations</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Reason / Note</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody>
          {% for row in transfer_rows %}
            {% set t = row.transfer %}
            <tr>
              <td data-label="Network">
                <div>{{ t.network }}</div>
                <div class="subline">req conf: {{ row.required_confirmations }}</div>
              </td>
              <td data-label="Tx hash" class="mono text-break">{{ t.tx_hash }}</td>
              <td data-label="Amount" class="mono">{{ t.amount|amt if t.amount else "-" }}</td>
              <td data-label="Confirmations">
                <div>{{ t.confirmations }} / {{ row.required_confirmations }}</div>
                <div class="progress-rail"><span style="width: {{ row.progress_percent }}%"></span></div>
              </td>
              <td data-label="Status">
                <span class="status-pill status-{{ row.status_tone }}">{{ row.status_label }}</span>
                <div class="subline">{{ row.status_description }}</div>
              </td>
              <td data-label="Payment" class="mono">
                {% if t.matched_payment_id %}
                  <a class="table-link" href="/admin/payments/{{ t.matched_payment_id }}">{{ t.matched_payment_id[:8] }}</a>
                {% else %}
                  -
                {% endif %}
              </td>
              <td data-label="Reason / Note">
                <div>{{ row.note }}</div>
              </td>
              <td data-label="Updated">{{ t.last_seen_at|dt }}</td>
            </tr>
          {% else %}
            <tr>
              <td class="empty-cell" colspan="8">Транзакций пока нет.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}
