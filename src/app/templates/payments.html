{% extends "base.html" %}
{% block content %}
  <section class="page-head">
    <div>
      <h1 class="page-title">Payments</h1>
      <p class="page-subtitle">Создавайте свои шаблоны быстрых инвойсов в USD и выпускайте счета одним кликом, меняя только валюту.</p>
    </div>
    <div class="actions">
      <a class="btn btn-outline" href="/admin/payments/new">Advanced Form</a>
    </div>
  </section>

  {% if error %}
    <div class="alert alert-error">{{ error }}</div>
  {% endif %}
  {% if info %}
    <div class="alert alert-success">{{ info }}</div>
  {% endif %}

  <section class="panel">
    <div class="panel-head">
      <div>
        <h2 class="panel-title">Template Builder</h2>
        <p class="panel-subtitle">Добавьте новый шаблон быстрых платежей в USD. Быстрый выпуск поддерживает и USDT, и BTC.</p>
      </div>
    </div>

    <form method="post" action="/admin/payments/templates/new" class="create-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <div class="form-grid">
        <label class="field">
          <span class="field-label">Template Name</span>
          <input type="text" name="title" required maxlength="255" placeholder="Subscription 30 days">
        </label>
        <label class="field">
          <span class="field-label">Price (USD)</span>
          <input type="text" name="usd_amount" required placeholder="9.90">
        </label>
      </div>
      <div class="form-grid">
        <label class="field">
          <span class="field-label">TTL (minutes)</span>
          <input type="number" name="ttl_minutes" min="1" max="1440" value="{{ default_template_ttl }}" required>
        </label>
        <label class="field">
          <span class="field-label">USDT Network (for USDT invoices)</span>
          <select name="usdt_network" required>
            {% for option in usdt_network_options %}
              <option value="{{ option.code }}" {% if option.code == default_template_usdt_network %}selected{% endif %}>
                {{ option.title }}
              </option>
            {% endfor %}
          </select>
          <span class="field-note">BTC всегда доступен в quick create и использует сеть Bitcoin [btc].</span>
        </label>
      </div>
      <div class="form-grid">
        <label class="field">
          <span class="field-label">BTC Network (fixed)</span>
          <input type="text" class="input-locked" value="Bitcoin (BTC) [btc]" readonly>
        </label>
      </div>
      <label class="field">
        <span class="field-label">Description</span>
        <textarea name="description" placeholder="Детали, которые попадут в инвойс"></textarea>
      </label>
      <label class="quick-lock-row">
        <input type="checkbox" name="is_active" value="1" checked>
        <span>Template is active</span>
      </label>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Create Template</button>
      </div>
    </form>
  </section>

  <section class="quick-grid">
    {% for template in quick_templates %}
      {% set usdt_label = "USDT (TRC20)" %}
      {% if template.usdt_network == "bsc_usdt" %}
        {% set usdt_label = "USDT (BEP20)" %}
      {% elif template.usdt_network == "eth_usdt" %}
        {% set usdt_label = "USDT (ERC20)" %}
      {% endif %}
      <article class="panel quick-card">
        <div class="quick-head">
          <span class="quick-icon quick-calendar"></span>
          <div>
            <h2 class="panel-title">{{ template.title }}</h2>
            <p class="panel-subtitle">{{ template.description or "Без описания" }}</p>
          </div>
          <span class="quick-price-badge">{{ template.usd_amount_text }} USD</span>
        </div>

        <div class="quick-template-meta">
          <span class="status-pill {% if template.is_active %}status-paid{% else %}status-expired{% endif %}">
            {% if template.is_active %}active{% else %}inactive{% endif %}
          </span>
          <span class="subline">USDT network: <span class="mono">{{ template.usdt_network }}</span></span>
          <span class="subline">BTC network: <span class="mono">btc</span></span>
          <span class="subline">Updated: {{ template.updated_at|dt }}</span>
        </div>

        <form method="post" action="/admin/payments/quick" class="quick-form" data-quick-create-form>
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="template_id" value="{{ template.id }}">
          <input type="hidden" data-usdt-network value="{{ template.usdt_network }}">
          <input type="hidden" data-usdt-label value="{{ usdt_label }}">

          <div class="form-grid">
            <label class="field">
              <span class="field-label">Currency</span>
              <div class="quick-currency-row">
                <label class="quick-currency-pill">
                  <input
                    type="radio"
                    name="currency"
                    value="USDT"
                    data-currency-input
                    checked
                    {% if not template.is_active %}disabled{% endif %}
                  >
                  <span>USDT</span>
                </label>
                <label class="quick-currency-pill">
                  <input
                    type="radio"
                    name="currency"
                    value="BTC"
                    data-currency-input
                    {% if not template.is_active %}disabled{% endif %}
                  >
                  <span>BTC</span>
                </label>
              </div>
            </label>
            <label class="field">
              <span class="field-label">Network</span>
              <select
                name="network"
                data-network-select
                data-initial-disabled="{% if template.is_active %}0{% else %}1{% endif %}"
                {% if not template.is_active %}disabled{% endif %}
              >
                <option value="{{ template.usdt_network }}">
                  {{ usdt_label }} [{{ template.usdt_network }}]
                </option>
                <option value="btc">
                  Bitcoin (BTC) [btc]
                </option>
              </select>
            </label>
          </div>

          <p class="subline quick-network-note" data-network-note>
            Для BTC используется native сеть Bitcoin, для USDT - сеть шаблона.
          </p>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" {% if not template.is_active %}disabled{% endif %}>Create Invoice</button>
          </div>
        </form>

        <form method="post" action="/admin/payments/templates/{{ template.id }}/update" class="quick-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

          <div class="form-grid">
            <label class="field">
              <span class="field-label">Template Name</span>
              <input type="text" name="title" value="{{ template.title }}" required maxlength="255">
            </label>
            <label class="field">
              <span class="field-label">Price (USD)</span>
              <input type="text" name="usd_amount" value="{{ template.usd_amount_text }}" required>
            </label>
          </div>

          <div class="form-grid">
            <label class="field">
              <span class="field-label">TTL (minutes)</span>
              <input type="number" name="ttl_minutes" min="1" max="1440" value="{{ template.ttl_minutes }}" required>
            </label>
            <label class="field">
              <span class="field-label">USDT Network</span>
              <select name="usdt_network" required>
                {% for option in usdt_network_options %}
                  <option value="{{ option.code }}" {% if option.code == template.usdt_network %}selected{% endif %}>
                    {{ option.title }}
                  </option>
                {% endfor %}
              </select>
            </label>
          </div>

          <div class="form-grid">
            <label class="field">
              <span class="field-label">BTC Network (fixed)</span>
              <input type="text" class="input-locked" value="Bitcoin (BTC) [btc]" readonly>
            </label>
          </div>

          <label class="field">
            <span class="field-label">Description</span>
            <textarea name="description">{{ template.description }}</textarea>
          </label>

          <label class="quick-lock-row">
            <input type="checkbox" name="is_active" value="1" {% if template.is_active %}checked{% endif %}>
            <span>Template is active</span>
          </label>

          <div class="form-actions">
            <button type="submit" class="btn btn-outline">Save Template</button>
          </div>
        </form>
      </article>
    {% else %}
      <article class="panel">
        <p class="subline">Шаблоны пока не созданы. Добавьте первый шаблон через Template Builder.</p>
      </article>
    {% endfor %}
  </section>

  <section class="panel">
    <div class="panel-head">
      <div>
        <h2 class="panel-title">Recent Payments</h2>
        <p class="panel-subtitle">Последние 200 инвойсов.</p>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Network</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody>
          {% for payment in payments %}
            <tr>
              <td data-label="ID"><a class="table-link mono" href="/admin/payments/{{ payment.id }}">{{ payment.id[:8] }}</a></td>
              <td data-label="Title">{{ payment.title }}</td>
              <td data-label="Network">{{ payment.network }}</td>
              <td data-label="Amount" class="mono">{{ payment.pay_amount|amt }} {{ payment.asset_symbol }}</td>
              <td data-label="Status"><span class="status-pill status-{{ payment.status }}">{{ payment.status }}</span></td>
              <td data-label="Created">{{ payment.created_at|dt }}</td>
            </tr>
          {% else %}
            <tr>
              <td class="empty-cell" colspan="6">Пока платежей нет.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <script>
    (function () {
      const forms = Array.from(document.querySelectorAll("[data-quick-create-form]"));
      if (!forms.length) {
        return;
      }

      const syncNetworkPreview = (form) => {
        const currencyInputs = Array.from(form.querySelectorAll("[data-currency-input]"));
        const usdtNetwork = form.querySelector("[data-usdt-network]");
        const usdtLabel = form.querySelector("[data-usdt-label]");
        const networkSelect = form.querySelector("[data-network-select]");
        const networkNote = form.querySelector("[data-network-note]");
        if (!currencyInputs.length || !networkSelect) {
          return;
        }

        const selectedCurrency = (
          currencyInputs.find((item) => item.checked)?.value || "USDT"
        ).toUpperCase();
        const initialDisabled = networkSelect.dataset.initialDisabled === "1";
        const usdtNetworkCode = usdtNetwork ? (usdtNetwork.value || "").trim() : "";
        const usdtNetworkLabel = usdtLabel ? (usdtLabel.value || "USDT") : "USDT";

        if (selectedCurrency === "BTC") {
          networkSelect.value = "btc";
          networkSelect.disabled = true;
          if (networkNote) {
            networkNote.textContent = "Вы выбрали BTC. Сеть фиксирована: Bitcoin [btc].";
          }
          return;
        }

        if (usdtNetworkCode) {
          networkSelect.value = usdtNetworkCode;
        }
        networkSelect.disabled = initialDisabled;
        if (networkNote) {
          networkNote.textContent = "Вы выбрали USDT. Используется сеть шаблона: " +
            usdtNetworkLabel +
            (usdtNetworkCode ? " [" + usdtNetworkCode + "]" : ".");
        }
      };

      for (const form of forms) {
        const currencyInputs = Array.from(form.querySelectorAll("[data-currency-input]"));
        syncNetworkPreview(form);
        for (const input of currencyInputs) {
          input.addEventListener("change", function () {
            syncNetworkPreview(form);
          });
        }
      }
    })();
  </script>
{% endblock %}
