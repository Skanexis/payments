{% extends "base.html" %}
{% block content %}
  <section class="page-head">
    <div>
      <h1 class="page-title">Payment {{ payment.id[:8] }}</h1>
      <p class="page-subtitle">Полная карточка платежа, логи и ручные действия администратора.</p>
    </div>
    <span class="status-pill status-{{ payment.status }}">{{ payment.status }}</span>
  </section>

  {% if error %}
    <div class="alert alert-error">{{ error }}</div>
  {% endif %}
  {% if info %}
    <div class="alert alert-success">{{ info }}</div>
  {% endif %}

  <section class="split-grid">
    <article class="panel">
      <h2 class="panel-title">Payment Details</h2>
      <div class="detail-list">
        <div class="detail-item">
          <div class="detail-key">Title</div>
          <div class="detail-value">{{ payment.title }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-key">Network</div>
          <div class="detail-value">{{ payment.network }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-key">Amount</div>
          <div class="detail-value mono">{{ amount_text }} {{ payment.asset_symbol }}</div>
        </div>
        {% if pricing and pricing.quote_currency %}
          <div class="detail-item">
            <div class="detail-key">Quoted Amount</div>
            <div class="detail-value mono">{{ base_amount_text }} {{ pricing.quote_currency }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-key">Locked Rate</div>
            <div class="detail-value mono">
              1 BTC = {{ pricing.btc_usd_rate }} {{ pricing.quote_currency }}
              {% if pricing.rate_source %}<span class="subline">source: {{ pricing.rate_source }}</span>{% endif %}
            </div>
          </div>
          <div class="detail-item">
            <div class="detail-key">Rate Locked At</div>
            <div class="detail-value">{{ pricing.quoted_at }}</div>
          </div>
        {% endif %}
        <div class="detail-item">
          <div class="detail-key">Destination Address</div>
          <div class="detail-value mono text-break">{{ payment.destination_address }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-key">Expires At</div>
          <div class="detail-value">{{ expires_at|dt }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-key">Tx Hash</div>
          <div class="detail-value mono text-break">{{ payment.tx_hash or "-" }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-key">Confirmations</div>
          <div class="detail-value">{{ payment.confirmations }} / {{ required_confirmations }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-key">Payment Link</div>
          <div class="detail-value"><a class="mono text-break" href="{{ pay_url }}" target="_blank">{{ pay_url }}</a></div>
        </div>
      </div>

      {% if payment.description %}
        <div class="hint-box">
          <p class="hint-title">Description</p>
          <div class="detail-value">{{ payment.description }}</div>
        </div>
      {% endif %}
    </article>

    <aside class="panel panel-soft">
      <h2 class="panel-title">Actions</h2>
      <p class="panel-subtitle">Ручные операции доступны только для pending/confirming.</p>

      <div class="actions action-stack">
        {% if payment.status == "pending" %}
          <form method="post" action="/admin/payments/{{ payment.id }}/cancel" class="full-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button class="btn btn-danger" type="submit">Cancel Payment</button>
          </form>
        {% endif %}

        {% if payment.status in ["pending", "confirming"] %}
          <form method="post" action="/admin/payments/{{ payment.id }}/mark-paid" class="inline-form full-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="text" name="manual_tx_hash" placeholder="manual tx hash (optional)">
            <button class="btn btn-outline" type="submit">Mark as Paid</button>
          </form>
        {% endif %}
      </div>

      <div class="hint-box">
        <p class="hint-title">Safety</p>
        <ul class="hint-list">
          <li>Перед ручным `paid` проверяйте tx в блокчейн-эксплорере.</li>
          <li>Сверяйте сеть, сумму и адрес назначения.</li>
        </ul>
      </div>
    </aside>
  </section>

  <section class="panel">
    <div class="panel-head">
      <div>
        <h2 class="panel-title">Payment Logs</h2>
        <p class="panel-subtitle">Хронология событий по этому платежу с event code и контекстом.</p>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Level</th>
            <th>Event</th>
            <th>Message</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% for row in log_rows %}
            <tr>
              <td data-label="Time">{{ row.item.created_at|dt }}</td>
              <td data-label="Level"><span class="log-pill log-{{ row.level_tone }}">{{ row.level_label }}</span></td>
              <td data-label="Event" class="mono">{{ row.event_code }}</td>
              <td data-label="Message">
                <div>{{ row.item.message }}</div>
                {% if row.reason %}
                  <div class="subline">reason: {{ row.reason }}</div>
                {% endif %}
                {% if row.reason_description %}
                  <div class="subline">{{ row.reason_description }}</div>
                {% endif %}
              </td>
              <td data-label="Details">
                {% if row.summary %}
                  <div class="context-list">
                    {% for line in row.summary %}
                      <span class="context-pill mono">{{ line }}</span>
                    {% endfor %}
                  </div>
                {% else %}
                  <span class="subline">-</span>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td class="empty-cell" colspan="5">Логи отсутствуют.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}
