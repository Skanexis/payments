{% extends "base.html" %}
{% block content %}
  <section class="panel pay-wrap">
    <div class="pay-header">
      <h1>{{ payment.title }}</h1>
      <p class="hint">{{ payment.description or "Оплатите счет по реквизитам ниже." }}</p>
    </div>
    <div>
      <div class="hint">К оплате</div>
      <div id="amount" class="big-amount mono">{{ pay_amount }} {{ payment.asset_symbol }}</div>
      <div class="actions" style="margin-top:.45rem;">
        <button id="copy-amount" class="btn btn-outline" type="button">Скопировать сумму</button>
      </div>
    </div>
    <div class="kvs">
      <div class="key">Сеть</div>
      <div class="val">{{ payment.network }}</div>
      <div class="key">Адрес кошелька</div>
      <div class="val">
        <span id="wallet-address">{{ payment.destination_address }}</span>
        <button id="copy-address" class="btn btn-outline" style="margin-left:.45rem;" type="button">Скопировать</button>
      </div>
      <div class="key">Срок оплаты</div>
      <div class="val">{{ expires_at|dt }}</div>
      <div class="key">Статус</div>
      <div class="val"><span id="status" class="status-pill status-{{ payment.status }}">{{ payment.status }}</span></div>
      <div class="key">Подтверждения</div>
      <div class="val"><span id="confirmations">{{ payment.confirmations }}</span> / <span id="required-confirmations">{{ payment_data.required_confirmations if payment_data else 1 }}</span></div>
      <div class="key">ID платежа</div>
      <div class="val">{{ payment.id }}</div>
      <div class="key">Tx hash</div>
      <div id="tx-hash" class="val">{{ payment.tx_hash or "-" }}</div>
    </div>
    <p class="hint">Отправьте <strong>точную сумму</strong> и в <strong>точно указанной сети</strong>. Статус обновится автоматически после нужных подтверждений сети.</p>
  </section>

  <script>
    (function () {
      const paymentId = "{{ payment.id }}";
      const statusNode = document.getElementById("status");
      const txNode = document.getElementById("tx-hash");
      const confirmationsNode = document.getElementById("confirmations");
      const requiredNode = document.getElementById("required-confirmations");
      const walletNode = document.getElementById("wallet-address");
      const amountNode = document.getElementById("amount");
      const copyAddressBtn = document.getElementById("copy-address");
      const copyAmountBtn = document.getElementById("copy-amount");

      const copyText = async (text, btn) => {
        try {
          await navigator.clipboard.writeText(text);
          if (btn) {
            const original = btn.textContent;
            btn.textContent = "Скопировано";
            setTimeout(() => { btn.textContent = original; }, 1200);
          }
        } catch (error) {
          console.warn("copy failed", error);
        }
      };

      const applyStatusClass = (status) => {
        statusNode.className = "status-pill status-" + status;
      };

      const fetchStatus = async () => {
        try {
          const response = await fetch("/api/payments/" + paymentId + "/status", { cache: "no-store" });
          if (!response.ok) {
            return;
          }
          const payload = await response.json();
          statusNode.textContent = payload.status;
          applyStatusClass(payload.status);
          txNode.textContent = payload.tx_hash || "-";
          confirmationsNode.textContent = payload.confirmations || 0;
          requiredNode.textContent = payload.required_confirmations || 1;
        } catch (error) {
          console.warn("status refresh failed", error);
        }
      };

      setInterval(fetchStatus, 8000);
      fetchStatus();

      if (copyAddressBtn && walletNode) {
        copyAddressBtn.addEventListener("click", () => copyText(walletNode.textContent.trim(), copyAddressBtn));
      }
      if (copyAmountBtn && amountNode) {
        copyAmountBtn.addEventListener("click", () => copyText(amountNode.textContent.trim(), copyAmountBtn));
      }
    })();
  </script>
{% endblock %}
