{% extends "base.html" %}
{% block content %}
  <section class="panel pay-shell">
    <div class="pay-layout">
      <div class="pay-main">
        <p class="pay-eyebrow">Платежный инвойс</p>
        <h1>{{ payment.title }}</h1>
        <p class="hint">{{ payment.description or "Оплатите счет по реквизитам ниже." }}</p>

        <div class="pay-amount-card">
          <div class="hint">К оплате</div>
          <p id="amount" data-amount="{{ pay_amount }}" class="pay-amount mono">{{ pay_amount }} {{ payment.asset_symbol }}</p>
          <div class="actions">
            <button id="copy-amount" class="btn btn-primary" type="button">Скопировать сумму</button>
            <button id="copy-address" class="btn btn-outline" type="button">Скопировать адрес</button>
          </div>
        </div>

        <div class="pay-status">
          <span id="status" class="status-pill status-{{ payment.status }}">{{ payment.status }}</span>
          <span class="hint">Подтверждения: <span id="confirmations">{{ payment.confirmations }}</span>/<span id="required-confirmations">{{ payment_data.required_confirmations if payment_data else 1 }}</span></span>
        </div>

        <p class="hint">Отправьте <strong>точную сумму</strong> и в <strong>точно указанной сети</strong>. Статус обновится автоматически после подтверждений сети.</p>
      </div>

      <aside class="pay-side">
        <div class="pay-meta">
          <div class="pay-meta-row">
            <span class="label">Сеть</span>
            <span class="value">{{ payment.network }}</span>
          </div>
          <div class="pay-meta-row">
            <span class="label">Адрес кошелька</span>
            <span id="wallet-address" class="value mono text-break">{{ payment.destination_address }}</span>
          </div>
          <div class="pay-meta-row">
            <span class="label">Срок оплаты</span>
            <span class="value">{{ expires_at|dt }}</span>
          </div>
          <div class="pay-meta-row">
            <span class="label">ID платежа</span>
            <span class="value mono text-break">{{ payment.id }}</span>
          </div>
          <div class="pay-meta-row">
            <span class="label">Tx hash</span>
            <span id="tx-hash" class="value mono text-break">{{ payment.tx_hash or "-" }}</span>
          </div>
        </div>

        <ol class="pay-steps">
          <li>Откройте кошелек и выберите сеть, указанную в инвойсе.</li>
          <li>Скопируйте сумму и адрес кнопками выше.</li>
          <li>Отправьте перевод и дождитесь обновления статуса.</li>
        </ol>
      </aside>
    </div>
  </section>

  <script>
    (function () {
      const paymentId = "{{ payment.id }}";
      const statusNode = document.getElementById("status");
      const txNode = document.getElementById("tx-hash");
      const confirmationsNode = document.getElementById("confirmations");
      const requiredNode = document.getElementById("required-confirmations");
      const walletNode = document.getElementById("wallet-address");
      const amountNode = document.getElementById("amount");
      const copyAddressBtn = document.getElementById("copy-address");
      const copyAmountBtn = document.getElementById("copy-amount");

      const copyText = async (text, btn) => {
        try {
          await navigator.clipboard.writeText(text);
          if (btn) {
            const original = btn.textContent;
            btn.textContent = "Скопировано";
            setTimeout(() => { btn.textContent = original; }, 1200);
          }
        } catch (error) {
          console.warn("copy failed", error);
        }
      };

      const applyStatusClass = (status) => {
        statusNode.className = "status-pill status-" + status;
      };

      const fetchStatus = async () => {
        try {
          const response = await fetch("/api/payments/" + paymentId + "/status", { cache: "no-store" });
          if (!response.ok) {
            return;
          }
          const payload = await response.json();
          statusNode.textContent = payload.status;
          applyStatusClass(payload.status);
          txNode.textContent = payload.tx_hash || "-";
          confirmationsNode.textContent = payload.confirmations || 0;
          requiredNode.textContent = payload.required_confirmations || 1;
        } catch (error) {
          console.warn("status refresh failed", error);
        }
      };

      setInterval(fetchStatus, 8000);
      fetchStatus();

      if (copyAddressBtn && walletNode) {
        copyAddressBtn.addEventListener("click", () => copyText(walletNode.textContent.trim(), copyAddressBtn));
      }
      if (copyAmountBtn && amountNode) {
        copyAmountBtn.addEventListener("click", () => copyText(amountNode.dataset.amount || amountNode.textContent.trim(), copyAmountBtn));
      }
    })();
  </script>
{% endblock %}
