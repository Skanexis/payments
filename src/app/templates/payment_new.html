{% extends "base.html" %}
{% block content %}
  <section class="page-head">
    <div>
      <h1 class="page-title">Create Payment</h1>
      <p class="page-subtitle">Создайте инвойс с уникальной суммой для точного авто-матчинга входящего перевода.</p>
    </div>
  </section>

  <section class="split-grid">
    <article class="panel">
      {% if error %}
        <div class="alert alert-error">{{ error }}</div>
      {% endif %}

      <form method="post" action="/admin/payments/new" class="create-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <label class="field">
          <span class="field-label">Title</span>
          <input type="text" name="title" required value="{{ values.title or '' }}" placeholder="Например: Доступ к приватному каналу">
        </label>

        <label class="field">
          <span class="field-label">External ID (optional)</span>
          <input type="text" name="external_id" value="{{ values.external_id or '' }}" placeholder="order-1001">
        </label>

        <div class="form-grid">
          <label class="field">
            <span class="field-label">Currency</span>
            <select id="currency-select" name="currency" required>
              <option value="USDT" {% if (values.currency or 'USDT') == 'USDT' %}selected{% endif %}>USDT</option>
              <option value="BTC" {% if values.currency == 'BTC' %}selected{% endif %}>BTC</option>
            </select>
          </label>
          <label class="field">
            <span class="field-label">Network</span>
            <select id="network-select" name="network" required>
              {% for option in network_options %}
                <option
                  value="{{ option.code }}"
                  data-currency="{{ option.currency }}"
                  data-input-currency="{{ option.input_currency }}"
                  {% if values.network == option.code %}selected{% endif %}
                  {% if not option.configured %}disabled{% endif %}
                >
                  {{ option.title }} {% if not option.configured %}(wallet не настроен){% endif %}
                </option>
              {% endfor %}
            </select>
          </label>
        </div>

        <div class="form-grid">
          <label class="field">
            <span id="amount-label" class="field-label">Price (USD)</span>
            <input type="text" name="base_amount" required value="{{ values.base_amount or '' }}" placeholder="19.90">
            <span class="field-note">USD фиксируется в инвойсе. Для BTC конвертация происходит в момент создания.</span>
          </label>
          <label class="field">
            <span class="field-label">TTL (minutes)</span>
            <input type="number" name="ttl_minutes" min="1" max="1440" value="{{ values.ttl_minutes or default_ttl }}">
          </label>
        </div>

        <label class="field">
          <span class="field-label">Description</span>
          <textarea name="description" placeholder="Описание для клиента">{{ values.description or '' }}</textarea>
        </label>

        <div class="form-actions sticky-actions">
          <button id="create-btn" class="btn btn-primary" type="submit">Create Payment</button>
          <a class="btn btn-outline" href="/admin">Cancel</a>
        </div>
      </form>
    </article>

    <aside class="panel panel-soft">
      <h2 class="panel-title">Network Settings</h2>
      <p class="panel-subtitle">Проверьте адреса и required confirmations перед созданием.</p>

      <div class="detail-list">
        {% for option in network_options %}
          <div class="detail-item">
            <div class="detail-key">{{ option.title }}</div>
            <div class="detail-value">wallet: <span class="mono text-break">{{ option.wallet or "не указан" }}</span></div>
            <div class="detail-value">confirmations: {{ option.required_confirmations }}</div>
          </div>
        {% endfor %}
      </div>

      <div class="hint-box">
        <p class="hint-title">Важно</p>
        <ul class="hint-list">
          <li>Клиент переводит только сумму, выданную инвойсом.</li>
          <li>Сеть должна совпадать с выбранной в инвойсе.</li>
          <li>Цена всегда задается в USD; курс для BTC фиксируется на TTL.</li>
          <li>Не настроенные сети автоматически отключены.</li>
        </ul>
      </div>
    </aside>
  </section>

  <script>
    (function () {
      const form = document.querySelector("form");
      const btn = document.getElementById("create-btn");
      const currencySelect = document.getElementById("currency-select");
      const networkSelect = document.getElementById("network-select");
      const amountLabel = document.getElementById("amount-label");
      if (!form || !btn) {
        return;
      }

      const filterNetworks = () => {
        if (!currencySelect || !networkSelect) {
          return;
        }
        const selectedCurrency = currencySelect.value || "USDT";
        let firstAllowed = "";
        for (const option of Array.from(networkSelect.options)) {
          const optionCurrency = option.dataset.currency || "USDT";
          const allowed = optionCurrency === selectedCurrency && !option.disabled;
          option.hidden = !allowed;
          if (allowed && !firstAllowed) {
            firstAllowed = option.value;
          }
        }
        const selected = networkSelect.options[networkSelect.selectedIndex];
        if (!selected || selected.hidden) {
          networkSelect.value = firstAllowed;
        }
      };

      const updateAmountLabel = () => {
        if (!networkSelect || !amountLabel) {
          return;
        }
        const selected = networkSelect.options[networkSelect.selectedIndex];
        const currency = selected ? (selected.dataset.inputCurrency || "USD") : "USD";
        amountLabel.textContent = "Price (" + currency + ")";
      };

      filterNetworks();
      updateAmountLabel();
      if (currencySelect) {
        currencySelect.addEventListener("change", function () {
          filterNetworks();
          updateAmountLabel();
        });
      }
      if (networkSelect) {
        networkSelect.addEventListener("change", updateAmountLabel);
      }

      form.addEventListener("submit", function () {
        btn.disabled = true;
        btn.textContent = "Creating...";
      });
    })();
  </script>
{% endblock %}
