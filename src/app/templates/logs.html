{% extends "base.html" %}
{% block content %}
  <section class="page-head">
    <div>
      <h1 class="page-title">Logs</h1>
      <p class="page-subtitle">Системный журнал бизнес-событий, ошибок интеграций и причин авто-матчинга.</p>
    </div>
  </section>

  <section class="kpi-grid kpi-grid-compact">
    <article class="kpi-card">
      <div class="kpi-label">Total Events</div>
      <div class="kpi-value">{{ log_total_count }}</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-label">Warnings</div>
      <div class="kpi-value">{{ log_warning_count }}</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-label">Errors</div>
      <div class="kpi-value">{{ log_error_count }}</div>
    </article>
  </section>

  <section class="panel">
    <div class="log-toolbar">
      <div class="range-switch" role="tablist" aria-label="Log level filter">
        <button type="button" class="range-btn active" data-log-level="all">All</button>
        <button type="button" class="range-btn" data-log-level="info">Info</button>
        <button type="button" class="range-btn" data-log-level="warning">Warning</button>
        <button type="button" class="range-btn" data-log-level="error">Error</button>
      </div>
      <label class="log-search">
        <span class="field-note">Search</span>
        <input id="log-search-input" type="text" placeholder="event, tx hash, ip, username...">
      </label>
      <span id="log-visible-count" class="subline">Showing {{ log_total_count }} events</span>
    </div>
  </section>

  <section class="panel">
    <div class="panel-head">
      <div>
        <h2 class="panel-title">Latest Events</h2>
        <p class="panel-subtitle">До 300 последних записей с event code, расшифровкой и контекстом.</p>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Level</th>
            <th>Event</th>
            <th>Meaning</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% for row in log_rows %}
            <tr class="log-row" data-level="{{ row.level_key }}">
              <td data-label="Time">{{ row.item.created_at|dt }}</td>
              <td data-label="Level"><span class="log-pill log-{{ row.level_tone }}">{{ row.level_label }}</span></td>
              <td data-label="Event">
                <div class="event-stack">
                  <span class="event-code mono">{{ row.event_code }}</span>
                  <span class="event-title event-tone-{{ row.event_tone }}">{{ row.event_title }}</span>
                </div>
              </td>
              <td data-label="Meaning">
                <div>{{ row.item.message }}</div>
                {% if row.event_description %}
                  <div class="subline">{{ row.event_description }}</div>
                {% endif %}
                {% if row.reason %}
                  <div class="subline">reason: {{ row.reason }}</div>
                {% endif %}
                {% if row.reason_description %}
                  <div class="subline">{{ row.reason_description }}</div>
                {% endif %}
                {% if row.item.payment_id %}
                  <div class="subline">payment: <a class="mono" href="/admin/payments/{{ row.item.payment_id }}">{{ row.item.payment_id[:8] }}</a></div>
                {% endif %}
              </td>
              <td data-label="Details">
                {% if row.details %}
                  <div class="context-list detail-list-grid">
                    {% for detail in row.details %}
                      <span class="context-pill detail-pill icon-{{ detail.icon }}">
                        <span class="pill-icon" aria-hidden="true"></span>
                        <span class="pill-label">{{ detail.label }}</span>
                        <span class="pill-value mono">{{ detail.value }}</span>
                      </span>
                    {% endfor %}
                  </div>
                {% else %}
                  <span class="subline">-</span>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td class="empty-cell" colspan="5">Логи отсутствуют.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <script>
    (function () {
      const rows = Array.from(document.querySelectorAll(".log-row"));
      const levelButtons = Array.from(document.querySelectorAll("[data-log-level]"));
      const searchInput = document.getElementById("log-search-input");
      const visibleCount = document.getElementById("log-visible-count");
      if (!rows.length || !levelButtons.length) {
        return;
      }

      let level = "all";
      let query = "";

      const updateCount = (visible) => {
        if (!visibleCount) {
          return;
        }
        visibleCount.textContent = "Showing " + visible + " of " + rows.length + " events";
      };

      const applyFilters = () => {
        let visible = 0;
        for (const row of rows) {
          const rowLevel = row.dataset.level || "";
          const text = row.textContent ? row.textContent.toLowerCase() : "";
          const levelMatch = level === "all" || rowLevel === level;
          const queryMatch = !query || text.includes(query);
          const show = levelMatch && queryMatch;
          row.style.display = show ? "" : "none";
          if (show) {
            visible += 1;
          }
        }
        updateCount(visible);
      };

      for (const button of levelButtons) {
        button.addEventListener("click", function () {
          level = button.dataset.logLevel || "all";
          for (const item of levelButtons) {
            item.classList.toggle("active", item === button);
          }
          applyFilters();
        });
      }

      if (searchInput) {
        searchInput.addEventListener("input", function () {
          query = (searchInput.value || "").trim().toLowerCase();
          applyFilters();
        });
      }

      applyFilters();
    })();
  </script>
{% endblock %}
