{% extends "base.html" %}
{% block content %}
  {% set stats_other = stats_total - stats_paid - stats_pending - stats_confirming %}
  {% if stats_other < 0 %}
    {% set stats_other = 0 %}
  {% endif %}

  <section class="page-head">
    <div>
      <h1 class="page-title">Dashboard</h1>
      <p class="page-subtitle">Контроль инвойсов, статусов оплаты, нагрузки и качества авто-матчинга.</p>
    </div>
    <div class="actions">
      <a class="btn btn-primary" href="/admin/payments/new">Create Payment</a>
    </div>
  </section>

  <section class="stats-grid">
    <article class="stat-card">
      <div class="stat-label">Total Payments</div>
      <div class="stat-value">{{ stats_total }}</div>
      <div class="stat-note">Все инвойсы в системе</div>
    </article>
    <article class="stat-card">
      <div class="stat-label">Pending</div>
      <div class="stat-value">{{ stats_pending }}</div>
      <div class="stat-note">Ожидают перевод</div>
    </article>
    <article class="stat-card">
      <div class="stat-label">Confirming</div>
      <div class="stat-value">{{ stats_confirming }}</div>
      <div class="stat-note">Есть tx, ждут подтверждения</div>
    </article>
    <article class="stat-card">
      <div class="stat-label">Paid</div>
      <div class="stat-value">{{ stats_paid }}</div>
      <div class="stat-note">Успешно завершены</div>
    </article>
  </section>

  <section class="insights-grid">
    <article class="panel chart-card">
      <div class="panel-head compact">
        <div>
          <h2 class="panel-title">Payment Mix</h2>
          <p class="panel-subtitle">Распределение текущих статусов.</p>
        </div>
      </div>

      <div class="donut-layout">
        <div class="donut-wrap">
          <div
            id="status-donut"
            class="donut-chart"
            data-paid="{{ stats_paid }}"
            data-pending="{{ stats_pending }}"
            data-confirming="{{ stats_confirming }}"
            data-other="{{ stats_other }}"
          ></div>
          <div class="donut-center">
            <span class="donut-center-value">{{ stats_total }}</span>
            <span class="donut-center-label">Total</span>
          </div>
        </div>

        <div class="legend-list">
          <div class="legend-row">
            <span class="legend-dot paid"></span>
            <span class="legend-name">Paid</span>
            <span class="legend-value">{{ stats_paid }}</span>
          </div>
          <div class="legend-row">
            <span class="legend-dot pending"></span>
            <span class="legend-name">Pending</span>
            <span class="legend-value">{{ stats_pending }}</span>
          </div>
          <div class="legend-row">
            <span class="legend-dot confirming"></span>
            <span class="legend-name">Confirming</span>
            <span class="legend-value">{{ stats_confirming }}</span>
          </div>
          <div class="legend-row">
            <span class="legend-dot other"></span>
            <span class="legend-name">Other</span>
            <span class="legend-value">{{ stats_other }}</span>
          </div>
        </div>
      </div>
    </article>

    <article class="panel chart-card">
      <div class="panel-head compact">
        <div>
          <h2 class="panel-title">Activity Timeline</h2>
          <p class="panel-subtitle">Интерактивная динамика создания инвойсов с переключением окна времени.</p>
        </div>
        <div class="range-switch" role="tablist" aria-label="Activity time range">
          <button type="button" class="range-btn" data-range="60m">60m</button>
          <button type="button" class="range-btn" data-range="24h">24h</button>
          <button type="button" class="range-btn active" data-range="7d">7d</button>
          <button type="button" class="range-btn" data-range="30d">30d</button>
        </div>
      </div>

      <div class="line-summary">
        <div class="line-summary-item">
          <span class="line-summary-label">Текущий интервал</span>
          <span id="today-count" class="line-summary-value">0</span>
        </div>
        <div class="line-summary-item">
          <span class="line-summary-label">Всего в окне</span>
          <span id="week-count" class="line-summary-value">0</span>
        </div>
        <div class="line-summary-item">
          <span class="line-summary-label">Пик интервала</span>
          <span id="peak-count" class="line-summary-value">0</span>
        </div>
      </div>

      <div class="line-chart-shell">
        <svg id="activity-chart" class="line-chart" viewBox="0 0 360 170" data-now="{{ now.isoformat() if now else '' }}" data-created="{% for payment in chart_payments %}{{ payment.created_at.isoformat() }}{% if not loop.last %},{% endif %}{% endfor %}">
          <g class="line-grid"></g>
          <polygon class="line-area" points=""></polygon>
          <polyline class="line-path" points=""></polyline>
          <g class="line-dots"></g>
        </svg>
        <div id="activity-tooltip" class="line-tooltip" hidden></div>
        <div id="activity-labels" class="line-labels"></div>
      </div>
    </article>
  </section>

  <section class="panel metric-help">
    <div class="metric-help-grid">
      <div class="metric-help-item">
        <span class="metric-help-dot dot-ok"></span>
        <span><strong>Match Rate:</strong> насколько хорошо система сама сопоставляет входящие переводы.</span>
      </div>
      <div class="metric-help-item">
        <span class="metric-help-dot dot-warn"></span>
        <span><strong>Transfer Issues:</strong> переводы, которым нужен ручной разбор (сумма/время/конфликт).</span>
      </div>
      <div class="metric-help-item">
        <span class="metric-help-dot dot-info"></span>
        <span><strong>TPM:</strong> transfers per minute, индикатор текущей нагрузки на мониторинг.</span>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-head">
      <div>
        <h2 class="panel-title">Enterprise Ops Metrics</h2>
        <p class="panel-subtitle">Финансовая и операционная аналитика по платежам и входящим переводам.</p>
      </div>
      <div>
        <span class="load-pill load-{{ enterprise.load_level }}">Load: {{ enterprise.load_level }}</span>
        <div class="subline">Updated: {{ now|dt }}</div>
      </div>
    </div>

    <div class="kpi-grid">
      <article class="kpi-card">
        <div class="kpi-label">Confirmed Volume Total</div>
        <div class="kpi-value mono">{{ enterprise.paid_volume_total }}</div>
        <div class="kpi-note">Подтвержденный оборот за все время</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Confirmed 24H</div>
        <div class="kpi-value mono">{{ enterprise.paid_volume_24h }}</div>
        <div class="kpi-note">Оплаты, перешедшие в paid за 24 часа</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Open Exposure</div>
        <div class="kpi-value mono">{{ enterprise.pending_exposure }}</div>
        <div class="kpi-note">Сумма активных pending + confirming</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Avg Settlement (min)</div>
        <div class="kpi-value">{{ enterprise.avg_settlement_minutes if enterprise.avg_settlement_minutes is not none else "-" }}</div>
        <div class="kpi-note">Среднее время закрытия инвойса</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Auto-Match Rate 24H</div>
        <div class="kpi-value">{{ enterprise.match_rate_24h ~ "%" if enterprise.match_rate_24h is not none else "-" }}</div>
        <div class="kpi-note">{{ enterprise.transfer_matched_24h }} из {{ enterprise.transfer_total_24h }} переводов matched</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Transfer Issues 24H</div>
        <div class="kpi-value">{{ enterprise.transfer_issues_24h }}</div>
        <div class="kpi-note">Проблемные кейсы, требующие ручной проверки</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Transfers Last Hour</div>
        <div class="kpi-value">{{ enterprise.transfers_last_hour }}</div>
        <div class="kpi-note">Пиковый TPM: {{ enterprise.peak_tpm }}</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Transfers 15m / 5m</div>
        <div class="kpi-value">{{ enterprise.transfers_last_15m }} / {{ enterprise.transfers_last_5m }}</div>
        <div class="kpi-note">Срез нагрузки за короткие интервалы</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Avg TPM (5m)</div>
        <div class="kpi-value">{{ enterprise.avg_tpm_5m }}</div>
        <div class="kpi-note">Среднее число переводов в минуту</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Invoices 60m</div>
        <div class="kpi-value">{{ enterprise.payments_created_60m }}</div>
        <div class="kpi-note">Новые инвойсы за последний час</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-label">Stale Active Payments</div>
        <div class="kpi-value">{{ enterprise.stale_active_count }}</div>
        <div class="kpi-note">Активные инвойсы, зависшие дольше нормы</div>
      </article>
    </div>
  </section>

  <section class="panel">
    <div class="panel-head">
      <div>
        <h2 class="panel-title">Network Capacity & Balance</h2>
        <p class="panel-subtitle">Текущая нагрузка, риски и live balance по каждой сети.</p>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Network</th>
            <th>Live Balance</th>
            <th>Active Payments</th>
            <th>Pending Volume</th>
            <th>Transfers 1H</th>
            <th>Issues 24H</th>
            <th>Load</th>
          </tr>
        </thead>
        <tbody>
          {% for row in enterprise.network_rows %}
            <tr>
              <td data-label="Network">
                <div>{{ row.title }}</div>
                <div class="subline">req conf: {{ row.required_confirmations }}</div>
              </td>
              <td data-label="Live Balance">
                {% if row.live_balance %}
                  <div class="mono">{{ row.live_balance }} {{ row.asset_symbol }}</div>
                {% else %}
                  <div class="subline">{{ row.live_balance_error }}</div>
                {% endif %}
              </td>
              <td data-label="Active Payments">{{ row.active_payments }}</td>
              <td data-label="Pending Volume" class="mono">{{ row.pending_volume }} {{ row.asset_symbol }}</td>
              <td data-label="Transfers 1H">{{ row.transfers_last_hour }}</td>
              <td data-label="Issues 24H">{{ row.issues_last_24h }}</td>
              <td data-label="Load">
                <div class="progress-rail"><span style="width: {{ row.load_percent }}%"></span></div>
                <div class="subline">{{ row.load_percent }}%</div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td class="empty-cell" colspan="7">Данные по сетям отсутствуют.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="panel">
    <div class="panel-head">
      <div>
        <h2 class="panel-title">Payments</h2>
        <p class="panel-subtitle">Последние 100 платежей с быстрым переходом в карточку.</p>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Network</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody>
          {% for payment in payments %}
            <tr>
              <td data-label="ID"><a class="table-link mono" href="/admin/payments/{{ payment.id }}">{{ payment.id[:8] }}</a></td>
              <td data-label="Title">{{ payment.title }}</td>
              <td data-label="Network">{{ payment.network }}</td>
              <td data-label="Amount" class="mono">{{ payment.pay_amount|amt }}</td>
              <td data-label="Status"><span class="status-pill status-{{ payment.status }}">{{ payment.status }}</span></td>
              <td data-label="Created">{{ payment.created_at|dt }}</td>
            </tr>
          {% else %}
            <tr>
              <td class="empty-cell" colspan="6">Пока платежей нет.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <script>
    (function () {
      const donutNode = document.getElementById("status-donut");
      if (donutNode) {
        const paid = Number(donutNode.dataset.paid || 0);
        const pending = Number(donutNode.dataset.pending || 0);
        const confirming = Number(donutNode.dataset.confirming || 0);
        const other = Number(donutNode.dataset.other || 0);
        const total = paid + pending + confirming + other;

        if (total > 0) {
          const paidPercent = (paid / total) * 100;
          const pendingPercent = (pending / total) * 100;
          const confirmingPercent = (confirming / total) * 100;
          const paidEnd = paidPercent;
          const pendingEnd = paidEnd + pendingPercent;
          const confirmingEnd = pendingEnd + confirmingPercent;

          donutNode.style.background = "conic-gradient(" +
            "#18a26d 0% " + paidEnd + "%," +
            "#c17a00 " + paidEnd + "% " + pendingEnd + "%," +
            "#2252c9 " + pendingEnd + "% " + confirmingEnd + "%," +
            "#93a2bd " + confirmingEnd + "% 100%)";
        }
      }

      const chartNode = document.getElementById("activity-chart");
      if (!chartNode) {
        return;
      }
      const rangeButtons = Array.from(document.querySelectorAll("[data-range]"));
      const tooltipNode = document.getElementById("activity-tooltip");
      const raw = chartNode.dataset.created || "";
      const nowRaw = chartNode.dataset.now || "";
      const createdDates = raw
        .split(",")
        .map((item) => item.trim())
        .filter(Boolean)
        .map((item) => {
          const hasTimezone = item.endsWith("Z") || item.includes("+");
          return new Date(hasTimezone ? item : item + "Z");
        })
        .filter((date) => !Number.isNaN(date.getTime()));

      const now = nowRaw ? new Date(nowRaw) : new Date();
      const ranges = {
        "60m": { bucketMinutes: 5, bucketCount: 12 },
        "24h": { bucketMinutes: 60, bucketCount: 24 },
        "7d": { bucketMinutes: 1440, bucketCount: 7 },
        "30d": { bucketMinutes: 1440, bucketCount: 30 }
      };
      let activeRange = "7d";

      const fmtHour = (d) => d.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" });
      const fmtDay = (d) => d.toLocaleDateString("en-GB", { day: "2-digit", month: "2-digit" });
      const startOfHourUtc = (d) => new Date(Date.UTC(
        d.getUTCFullYear(),
        d.getUTCMonth(),
        d.getUTCDate(),
        d.getUTCHours(),
        0,
        0,
        0
      ));
      const startOfDayUtc = (d) => new Date(Date.UTC(
        d.getUTCFullYear(),
        d.getUTCMonth(),
        d.getUTCDate(),
        0,
        0,
        0,
        0
      ));
      const alignToBucketUtc = (d, bucketMinutes) => {
        const mins = d.getUTCMinutes();
        const aligned = Math.floor(mins / bucketMinutes) * bucketMinutes;
        return new Date(Date.UTC(
          d.getUTCFullYear(),
          d.getUTCMonth(),
          d.getUTCDate(),
          d.getUTCHours(),
          aligned,
          0,
          0
        ));
      };

      const buildSeries = (rangeKey) => {
        const cfg = ranges[rangeKey] || ranges["7d"];
        const bucketMs = cfg.bucketMinutes * 60000;
        const endStart = cfg.bucketMinutes < 1440 ? alignToBucketUtc(now, cfg.bucketMinutes) : startOfDayUtc(now);
        const coverageStart = new Date(endStart.getTime() - ((cfg.bucketCount - 1) * bucketMs));
        const coverageEnd = new Date(endStart.getTime() + bucketMs);
        const labels = [];
        const counts = Array.from({ length: cfg.bucketCount }, () => 0);

        for (let i = 0; i < cfg.bucketCount; i += 1) {
          const bucketStart = new Date(coverageStart.getTime() + (i * bucketMs));
          labels.push(cfg.bucketMinutes < 1440 ? fmtHour(bucketStart) : fmtDay(bucketStart));
        }

        for (const ts of createdDates) {
          const time = ts.getTime();
          if (time < coverageStart.getTime() || time >= coverageEnd.getTime()) {
            continue;
          }
          const idx = Math.floor((time - coverageStart.getTime()) / bucketMs);
          if (idx >= 0 && idx < counts.length) {
            counts[idx] += 1;
          }
        }

        return { counts, labels };
      };

      const renderSeries = (series) => {
        const counts = series.counts;
        const labels = series.labels;
        const currentBucket = counts[counts.length - 1] || 0;
        const windowTotal = counts.reduce((acc, value) => acc + value, 0);
        const peakBucket = Math.max(...counts, 0);
        const todayNode = document.getElementById("today-count");
        const weekNode = document.getElementById("week-count");
        const peakNode = document.getElementById("peak-count");
        if (todayNode) {
          todayNode.textContent = String(currentBucket);
        }
        if (weekNode) {
          weekNode.textContent = String(windowTotal);
        }
        if (peakNode) {
          peakNode.textContent = String(peakBucket);
        }
        if (tooltipNode) {
          tooltipNode.hidden = true;
        }

        const labelsNode = document.getElementById("activity-labels");
        if (labelsNode) {
          const step = labels.length > 12 ? Math.ceil(labels.length / 8) : 1;
          labelsNode.innerHTML = labels
            .map((label, idx) => {
              const visible = idx % step === 0 || idx === labels.length - 1;
              return "<span class='" + (visible ? "" : "label-muted") + "'>" + (visible ? label : " ") + "</span>";
            })
            .join("");
        }

        const max = Math.max(...counts, 1);
        const width = 360;
        const height = 170;
        const left = 14;
        const right = 14;
        const top = 12;
        const bottom = 28;
        const usableWidth = width - left - right;
        const usableHeight = height - top - bottom;

        const points = counts.map((count, idx) => {
          const x = left + (idx * usableWidth) / Math.max(1, counts.length - 1);
          const y = top + usableHeight - (count / max) * usableHeight;
          return { x, y };
        });

        const gridNode = chartNode.querySelector(".line-grid");
        if (gridNode) {
          gridNode.innerHTML = "";
          const xmlns = "http://www.w3.org/2000/svg";
          [0, 0.25, 0.5, 0.75, 1].forEach((level) => {
            const y = top + usableHeight - usableHeight * level;
            const line = document.createElementNS(xmlns, "line");
            line.setAttribute("x1", String(left));
            line.setAttribute("x2", String(left + usableWidth));
            line.setAttribute("y1", String(y));
            line.setAttribute("y2", String(y));
            gridNode.appendChild(line);
          });
        }

        const areaNode = chartNode.querySelector(".line-area");
        if (areaNode) {
          const areaPoints = [
            left + "," + (top + usableHeight),
            ...points.map((point) => point.x + "," + point.y),
            left + usableWidth + "," + (top + usableHeight),
          ];
          areaNode.setAttribute("points", areaPoints.join(" "));
        }

        const pathNode = chartNode.querySelector(".line-path");
        if (pathNode) {
          pathNode.setAttribute("points", points.map((point) => point.x + "," + point.y).join(" "));
        }

        const dotsNode = chartNode.querySelector(".line-dots");
        if (dotsNode) {
          dotsNode.innerHTML = "";
          const xmlns = "http://www.w3.org/2000/svg";
          points.forEach((point, idx) => {
            const dot = document.createElementNS(xmlns, "circle");
            dot.setAttribute("cx", String(point.x));
            dot.setAttribute("cy", String(point.y));
            dot.setAttribute("r", "3.5");
            dot.dataset.count = String(counts[idx]);
            dot.dataset.label = labels[idx];
            dotsNode.appendChild(dot);
          });
        }

        const dots = Array.from(chartNode.querySelectorAll(".line-dots circle"));
        dots.forEach((dot) => {
          dot.addEventListener("mouseenter", function (event) {
            if (!tooltipNode) {
              return;
            }
            const label = dot.dataset.label || "";
            const count = dot.dataset.count || "0";
            tooltipNode.textContent = label + " - " + count;
            tooltipNode.hidden = false;
            const chartRect = chartNode.getBoundingClientRect();
            const targetRect = event.target.getBoundingClientRect();
            tooltipNode.style.left = (targetRect.left - chartRect.left + 8) + "px";
            tooltipNode.style.top = (targetRect.top - chartRect.top - 8) + "px";
          });
          dot.addEventListener("mouseleave", function () {
            if (tooltipNode) {
              tooltipNode.hidden = true;
            }
          });
        });
      };

      const applyRange = (rangeKey) => {
        activeRange = ranges[rangeKey] ? rangeKey : "7d";
        for (const button of rangeButtons) {
          button.classList.toggle("active", button.dataset.range === activeRange);
        }
        renderSeries(buildSeries(activeRange));
      };

      for (const button of rangeButtons) {
        button.addEventListener("click", function () {
          applyRange(button.dataset.range || "7d");
        });
      }

      applyRange(activeRange);
    })();
  </script>
{% endblock %}
