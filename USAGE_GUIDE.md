# Инструкция по использованию: админка + бот + пользовательский сценарий

Документ описывает, как пользоваться системой после деплоя:
- со стороны **админа** (UI админки и Telegram-бот);
- со стороны **пользователя** (оплата по ссылке).

---

## 1. Роли в системе

1. `Админ`:
   - создает платежи;
   - отслеживает статусы;
   - разбирает спорные транзакции;
   - при необходимости делает ручные действия.
2. `Пользователь`:
   - получает ссылку на оплату;
   - отправляет сумму в нужной сети;
   - ждет автоматического подтверждения.

---

## 2. Что важно знать перед началом

1. В проекте сейчас принимается:
   - `tron_usdt` (USDT TRC20),
   - `bsc_usdt` (USDT BEP20),
   - `eth_usdt` (USDT ERC20),
   - `btc` (Bitcoin).
2. Сопоставление платежа идет по:
   - сети,
   - точной сумме,
   - временным окнам.
3. Статусы платежа:
   - `pending` — ожидаем перевод;
   - `confirming` — перевод найден, ждем подтверждения сети;
   - `paid` — оплата подтверждена;
   - `expired` — время вышло;
   - `cancelled` — отменено админом.

---

## 3. Админка: первый вход

1. Откройте:
   - `https://ВАШ_ПОДДОМЕН/admin/login`
2. Введите:
   - `ADMIN_USERNAME`,
   - `ADMIN_PASSWORD` из `.env`.
3. После входа откроется Dashboard (`/admin`).

Если логин не подходит:
1. проверьте `.env`;
2. при необходимости установите новый пароль:

```bash
cd /opt/crypto-pay/payments
source .venv/bin/activate
PYTHONPATH=src python scripts/create_admin.py --username admin --password 'NewAdminPass123'
sudo systemctl restart crypto-pay-web
```

---

## 4. Админка: создание платежа

### Вариант A: быстрые платежи (новая вкладка Payments)

1. Откройте:
   - `/admin/payments`
2. Выберите шаблон:
   - `Subscription 30 days`,
   - `Subscription 90 days`,
   - `Pro Support`,
   - `Lifetime Access`.
3. Для каждого инвойса задайте:
   - `Currency` (`USDT` или `BTC`);
   - `Network` (сеть под выбранную валюту);
   - `Price (USD)` (фиксированная цена заказа);
   - `TTL`.
4. Нажмите `Create Quick Invoice`.
5. Система откроет карточку платежа `/admin/payments/<id>`.

### Вариант B: расширенная форма (advanced)

1. Перейдите в `Создать` (`/admin/payments/new`).
2. Заполните поля:
   - `Название` — что оплачивает клиент;
   - `Внешний ID` (опционально) — ваш номер заказа (`order-1001`);
   - `Currency` — `USDT` или `BTC`;
   - `Сеть` — `tron_usdt`, `bsc_usdt`, `eth_usdt` или `btc`;
   - `Price (USD)` — цена всегда задается в USD;
   - `TTL` — время жизни инвойса в минутах;
   - `Описание` — текст для клиента.
3. Нажмите `Создать платеж`.
4. Откроется страница платежа `/admin/payments/<id>`.
5. Скопируйте ссылку оплаты:
   - `https://ВАШ_ПОДДОМЕН/pay/<payment_id>`
6. Отправьте ссылку клиенту.

### Что система делает автоматически

1. Создает уникальную сумму (`base_amount + offset`), чтобы не путать платежи.
2. Для `btc`:
   - берет введенную сумму в USD;
   - считает BTC по текущему курсу;
   - фиксирует курс в момент создания инвойса (дальше не пересчитывает);
   - если основной API курса недоступен, пробует fallback-провайдеры автоматически.
3. Запоминает сеть и адрес получения.
4. Запускает авто-мониторинг входящих переводов.

---

## 5. Админка: как следить за оплатами

### Dashboard `/admin`

Показывает:
1. общее число платежей;
2. `pending`;
3. `confirming`;
4. `paid`.
5. `Activity Timeline` с диапазонами `60m`, `24h`, `7d`, `30d`;
6. поминутные/почасовые метрики нагрузки (`Transfers 15m/5m`, `Avg TPM (5m)`, `Invoices 60m`);
7. enterprise-блок с объемами, авто-матчингом, stale-платежами и live balance по сетям.

### Payments `/admin/payments`

Показывает:
1. быстрые шаблоны создания инвойсов;
2. выбор валюты/сети при каждом создании;
3. последние платежи (реестр) с переходом в карточку.

### Карточка платежа `/admin/payments/<id>`

Смотрите:
1. статус;
2. сеть;
3. сумму к оплате;
4. `tx_hash` (если найден);
5. подтверждения (`confirmations / required`);
6. логи платежа.

### Реестр транзакций `/admin/transfers`

Показывает все обнаруженные входящие переводы:
1. какие сматчились;
2. какие не сматчились и почему:
   - `amount_mismatch`,
   - `before_invoice`,
   - `after_expired`,
   - `conflict`,
   - `awaiting_confirmations`,
   - `matched`.

### Системные логи `/admin/logs`

Используйте для диагностики:
1. ошибок API/монитора;
2. ручных действий админа;
3. причин, почему перевод не засчитан автоматически.

---

## 6. Админка: ручные действия

На странице платежа:

1. `Отменить`:
   - переводит `pending` -> `cancelled`;
   - используйте, если заказ отменен.
2. `Отметить как paid`:
   - ручное подтверждение платежа;
   - можно указать `manual tx hash`.

Использовать ручное подтверждение стоит только после проверки реального перевода.

---

## 7. Telegram-бот: работа для админа

Бот — инструмент админа, не публичная касса.

### Подготовка

1. В `.env` должны быть:
   - `TELEGRAM_BOT_TOKEN=...`
   - `TELEGRAM_ADMIN_IDS=...` (через запятую)
2. Запустите сервис бота (`crypto-pay-bot`) или вручную:

```bash
cd /opt/crypto-pay/payments
source .venv/bin/activate
PYTHONPATH=src python -m app.telegram_bot
```

### Команды

1. `/start` или `/help`
   - список команд.
2. `/invoice <network> <amount> <title>`
   - создает инвойс.

Пример:
```text
/invoice tron_usdt 25.50 Premium access 30 days
```

Для BTC:
```text
/invoice btc 1.50 Invoice #1001
```

3. `/status <payment_id>`
   - показывает статус платежа.

Пример:
```text
/status 2b17f8e1-xxxx-xxxx-xxxx-8d6f0a0ec8f3
```

### Что получает админ от бота

1. ID платежа;
2. сеть;
3. сумму;
4. адрес;
5. ссылку оплаты;
6. текущий статус (по запросу `/status`).

---

## 8. Пользовательский сценарий оплаты (клиент)

### Что получает пользователь

1. ссылку вида:
   - `https://ВАШ_ПОДДОМЕН/pay/<payment_id>`
2. на странице видит:
   - сумму;
   - сеть;
   - адрес;
   - срок оплаты;
   - статус.

### Что должен сделать пользователь

1. Открыть ссылку.
2. Скопировать адрес и сумму кнопками.
3. В своем кошельке отправить **ровно указанную сумму**.
4. Отправить в **той же сети**, что указана на странице:
   - `TRC20` только для `tron_usdt`;
   - `BEP20` только для `bsc_usdt`;
   - `ERC20` только для `eth_usdt`;
   - `Bitcoin` только для `btc`.
5. Подождать обновления статуса:
   - сначала `pending`/`confirming`,
   - потом `paid`.

### Что нельзя делать

1. Отправлять в другой сети.
2. Менять сумму “на глаз”.
3. Отправлять после истечения TTL (может уйти в `expired` и требовать ручной разбор).

---

## 9. Частые ситуации и что делать

### 1. Пользователь отправил, но `pending`

Проверьте:
1. `/admin/transfers`;
2. `/admin/logs`;
3. правильность сети и суммы.

### 2. Статус `confirming` долго

1. Нормально при задержках сети.
2. Смотрите поле подтверждений.
3. Дождитесь `required_confirmations`.

### 3. Платеж ушел в `expired`, но перевод пришел

1. Найдите транзакцию в `/admin/transfers`.
2. Проверьте вручную в обозревателе сети.
3. Если перевод валиден — вручную подтвердите платеж (`mark paid`) или создайте внутреннюю корректировку по вашему процессу.

---

## 10. Рекомендованный ежедневный процесс для админа

1. Проверить `/admin` (новые `pending`/`confirming`).
2. Проверить `/admin/transfers` (нераспознанные).
3. Проверить `/admin/logs` (ошибки интеграций).
4. При спорных кейсах:
   - сверить tx в explorer,
   - принять решение вручную.

---

## 11. Быстрый чек после запуска/обновления

1. `https://ВАШ_ПОДДОМЕН/health` = `ok`.
2. Вход в `/admin/login` работает.
3. Создание платежа из UI работает.
4. Страница `/pay/<id>` открывается.
5. Тестовый перевод меняет статус до `paid`.
6. Бот отвечает на `/start`.
